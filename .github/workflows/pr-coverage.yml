name: PR Coverage

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: pr-coverage-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  test-and-coverage:
    runs-on: ubuntu-latest

    # Allow the workflow to post/update comments on the PR
    permissions:
      contents: read
      pull-requests: write

    env:
      # Adjust these as needed for your project
      MIN_COVERAGE_OVERALL: 90
      MIN_COVERAGE_CHANGED: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: 'gradle'
          cache-dependency-path: |
            backend/build.gradle
            backend/settings.gradle
            backend/gradle/wrapper/gradle-wrapper.properties

      # Run tests + JaCoCo report for the backend module
      - name: Run tests with JaCoCo (backend)
        working-directory: ./backend
        run: |
          chmod +x gradlew
          ./gradlew test jacocoTestReport

      # Upload HTML reports as build artifacts for manual inspection (optional but nice)
      - name: Upload JaCoCo HTML report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-html-report
          path: backend/build/jacocoHtml/

      - name: Upload test report HTML
        uses: actions/upload-artifact@v4
        with:
          name: junit-test-report
          path: backend/build/reports/tests/test/

      # Create or update a PR comment with overall + changed-files coverage
      # continue-on-error prevents the action's internal threshold check from failing the workflow
      # Our explicit check at the end handles failures with proper edge case handling
      - name: JaCoCo Report to PR
        id: jacoco
        uses: madrapps/jacoco-report@v1.7.2
        continue-on-error: true
        with:
          # JaCoCo XML report produced by Gradle in your backend module
          paths: |
            ${{ github.workspace }}/backend/build/reports/jacoco/test/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: ${{ env.MIN_COVERAGE_OVERALL }}
          min-coverage-changed-files: ${{ env.MIN_COVERAGE_CHANGED }}
          title: 'Code Coverage'
          update-comment: true
          comment-type: pr_comment

      # Append HTML report links *inside the same coverage comment*
      - name: Append HTML report links to coverage comment
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}#artifacts`;

            // Get all comments on the PR
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100,
            });

            // Find the coverage comment created by madrapps/jacoco-report
            const coverageComment = comments
              .slice() // shallow copy
              .reverse() // start from newest
              .find(c =>
                c.user?.type === 'Bot' &&
                c.body &&
                c.body.includes('Code Coverage')
              );

            if (!coverageComment) {
              console.log('No coverage comment found to update');
              return;
            }

            const linksSection = [
              '',
              '---',
              'ðŸ§ª **Test & Coverage Reports (HTML)**',
              '',
              `- [JaCoCo HTML report](${runUrl})`,
              `- [JUnit test report](${runUrl})`,
              '',
              '_Open the Action run â†’ scroll to **Artifacts** â†’ download the ZIPs and open `index.html` locally._'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner,
              repo,
              comment_id: coverageComment.id,
              body: coverageComment.body + linksSection,
            });

      # Validate coverage thresholds using shell for proper numeric comparison
      # GitHub Actions expressions don't handle floating-point comparison well
      - name: Validate coverage thresholds
        env:
          COVERAGE_OVERALL: ${{ steps.jacoco.outputs.coverage-overall }}
          COVERAGE_CHANGED: ${{ steps.jacoco.outputs.coverage-changed-files }}
        run: |
          # Default changed files coverage to 100 if empty (no Java files changed)
          CHANGED="${COVERAGE_CHANGED:-100}"
          
          echo "Coverage Results:"
          echo "  Overall:  ${COVERAGE_OVERALL}% (min: ${{ env.MIN_COVERAGE_OVERALL }}%)"
          echo "  Changed:  ${CHANGED}% (min: ${{ env.MIN_COVERAGE_CHANGED }}%)"
          
          # Use bc for floating-point comparison
          OVERALL_FAIL=$(echo "${COVERAGE_OVERALL} < ${{ env.MIN_COVERAGE_OVERALL }}" | bc -l)
          CHANGED_FAIL=$(echo "${CHANGED} < ${{ env.MIN_COVERAGE_CHANGED }}" | bc -l)
          
          if [ "$OVERALL_FAIL" -eq 1 ] || [ "$CHANGED_FAIL" -eq 1 ]; then
            echo ""
            echo "::error::Coverage below threshold!"
            exit 1
          else
            echo ""
            echo "âœ… Coverage thresholds met!"
          fi
