name: CourtierPro CI/CD

on:
  push:
    branches: ["main"]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/backend
          tags: |
            type=raw,value=latest
            type=sha
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.title=CourtierPro Backend
            org.opencontainers.image.description=Backend service for CourtierPro application

      - name: Extract metadata (tags, labels) for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/frontend
          tags: |
            type=raw,value=latest
            type=sha
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.title=CourtierPro Frontend
            org.opencontainers.image.description=Frontend application for CourtierPro

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (for docker-compose file)
        uses: actions/checkout@v4

      - name: Transfer Docker Compose file
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "docker-compose.prod.yml"
          target: "courtierpro"

      - name: Deploy to EC2 (rollback if containers fail)
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            # Helper function for health checks
            check_health() {
              url=$1
              timeout=60
              interval=5
              elapsed=0

              echo "Waiting for $url to be healthy (status=UP)..."
              while [ $elapsed -lt $timeout ]; do
                response=$(curl -s -f "$url" || true)
                if echo "$response" | grep -q '"status"[[:space:]]*:[[:space:]]*"UP"'; then
                  echo "$url is up!"
                  return 0
                fi
                sleep $interval
                elapsed=$((elapsed + interval))
              done
              echo "Timeout waiting for $url"
              return 1
            }

            # Ensure dependencies
            if ! command -v curl >/dev/null 2>&1; then
              echo "curl is not installed. Please install it."
              exit 1
            fi

            # Handle migration from legacy Git-based deployment, if present
            if [ -d "$HOME/courtierpro/.git" ] && [ ! -f "$HOME/courtierpro/docker-compose.prod.yml" ]; then
              echo "Detected legacy Git-based deployment in ~/courtierpro. Backing it up..."
              ts=$(date +%Y%m%d%H%M%S)
              mv "$HOME/courtierpro" "$HOME/courtierpro_legacy_$ts"
            fi

            mkdir -p "$HOME/courtierpro"
            cd "$HOME/courtierpro"
            # 1. Backup: Tag current images as 'rollback' before pulling new ones
            echo "Backing up current images..."
            if docker image inspect ghcr.io/${{ github.repository }}/backend:latest >/dev/null 2>&1; then
              docker tag ghcr.io/${{ github.repository }}/backend:latest ghcr.io/${{ github.repository }}/backend:rollback
            fi
            if docker image inspect ghcr.io/${{ github.repository }}/frontend:latest >/dev/null 2>&1; then
              docker tag ghcr.io/${{ github.repository }}/frontend:latest ghcr.io/${{ github.repository }}/frontend:rollback
            fi

            # 2. Deploy New Version
            echo "Logging into GitHub Container Registry (GHCR)..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
            echo "Pulling new images..."
            docker compose -f docker-compose.prod.yml pull

            echo "Starting services..."
            docker compose -f docker-compose.prod.yml up -d --remove-orphans

            # 3. Wait for DB / Services to Init
            echo "Waiting 15s for services to stabilize..."
            sleep 15

            # 4. Health Checks with Rollback
            # Backend uses Spring Boot Actuator, Frontend uses Nginx
            if check_health "http://localhost:8080/actuator/health" && check_health "http://localhost:8081"; then
              echo "Deployment successful!"
              docker system prune -f
            else
              echo "Health checks failed! Initiating rollback to previous version..."

              # Restore logic: Tag the 'rollback' image back to 'latest' locally
              # This forces 'compose up' to use the old image SHA
              
              if docker image inspect ghcr.io/${{ github.repository }}/backend:rollback >/dev/null 2>&1; then
                echo "Restoring Backend..."
                docker tag ghcr.io/${{ github.repository }}/backend:rollback ghcr.io/${{ github.repository }}/backend:latest
              fi

              if docker image inspect ghcr.io/${{ github.repository }}/frontend:rollback >/dev/null 2>&1; then
                echo "Restoring Frontend..."
                docker tag ghcr.io/${{ github.repository }}/frontend:rollback ghcr.io/${{ github.repository }}/frontend:latest
              fi

              # Restart with the restored images
              docker compose -f docker-compose.prod.yml up -d --remove-orphans
              
              echo "Rollback completed. Exiting with failure."
              exit 1
            fi
