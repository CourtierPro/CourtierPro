name: Validate Branch and PR Naming

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  validate-names:
    runs-on: ubuntu-latest

    steps:
      - name: Validate branch + PR naming convention
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prTitle = pr.title;
            const branchName = pr.head.ref;

            // -----------------------
            // PR TITLE RULES
            // -----------------------

            // Required for ALL types except Untracked
            // Bug|Feat|Fix|Story|Task|Test(CP-44): Description
            const prWithTicketPattern =
              /^(Bug|Feat|Fix|Story|Task|Test)\(CP-\d+\): .+/;

            // Exception: Untracked
            // Untracked: Description
            const prUntrackedPattern =
              /^Untracked: .+/;

            // -----------------------
            // BRANCH NAME RULES
            // -----------------------

            // Required for ALL types except untracked
            // bug|feat|fix|story|task|test/CP-44_Description
            const branchWithTicketPattern =
              /^(bug|feat|fix|story|task|test)\/CP-\d+_[A-Za-z0-9._-]+$/;

            // Exception: untracked
            // untracked/Description
            const branchUntrackedPattern =
              /^untracked\/[A-Za-z0-9._-]+$/;

            const prIsValid =
              prWithTicketPattern.test(prTitle) ||
              prUntrackedPattern.test(prTitle);

            const branchIsValid =
              branchWithTicketPattern.test(branchName) ||
              branchUntrackedPattern.test(branchName);

            if (!prIsValid || !branchIsValid) {
              let msg = '❌ Naming convention check failed.\n\n';
              msg += `PR title: "${prTitle}"\n`;
              msg += `Branch name: "${branchName}"\n\n`;

              msg += 'Problems detected:\n';
              if (!prIsValid) {
                msg += '• PR title is invalid.\n';
              }
              if (!branchIsValid) {
                msg += '• Branch name is invalid.\n';
              }

              msg += '\nExpected formats:\n';
              msg += 'PR (with ticket): Bug|Feat|Fix|Story|Task|Test(CP-44): Description\n';
              msg += 'PR (no ticket):   Untracked: Description\n\n';
              msg += 'Branch (with ticket): bug|feat|fix|story|task|test/CP-44_Description\n';
              msg += 'Branch (no ticket):   untracked/Description\n';

              core.setFailed(msg);
              return;
            }

            console.log('✅ Branch name and PR title follow the convention.');
