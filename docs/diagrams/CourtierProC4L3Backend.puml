@startuml
!includeurl https://raw.githubusercontent.com/RicardoNiepel/C4-PlantUML/master/C4_Component.puml
scale 0.42
!$ICONURL = "https://raw.githubusercontent.com/tupadr3/plantuml-icon-font-sprites/v3.0.0/icons"
!include $ICONURL/common.puml
!include $ICONURL/devicons2/spring_original.puml
!include $ICONURL/devicons/react.puml
!include $ICONURL/devicons/html5.puml
!include $ICONURL/devicons/postgresql.puml
!include $ICONURL/font-awesome-5/envelope.puml
!include $ICONURL/font-awesome-5/cloud.puml
!include $ICONURL/font-awesome-5/user.puml

AddElementTag("microService-java", $shape=EightSidedShape(), $bgColor="#FFDB33", $borderColor="Black", $fontColor="black", $legendText="Spring Boot Container")
AddElementTag("framework-react", $shape=RoundedBoxShape(), $bgColor="#61DBFB", $borderColor="Black", $fontColor="white", $legendText="React SPA (Vite)")
AddElementTag("storage-postgres", $shape=RoundedBoxShape(), $bgColor="#336791", $borderColor="Black", $fontColor="white", $legendText="PostgreSQL 15")
AddElementTag("webApp", $bgColor="#e34f26", $fontColor="white", $legendText="Web Application (HTML5)")

AddRelTag("purple-line", $lineColor="purple", $legendText="API Calls (REST)")
AddRelTag("blue-line", $lineColor="blue", $legendText="Auth / Sessions")
AddRelTag("green-line", $lineColor="green", $legendText="Documents (R2)")
AddRelTag("orange-line", $lineColor="orange", $legendText="Appointments (domain data)")
AddRelTag("red-line", $lineColor="red", $legendText="Analytics (domain data)")


SHOW_PERSON_OUTLINE()

title CourtierPro — C4 Level 3 (Backend API Components)

System_Boundary(cp, "CourtierPro System") {

  ' Context containers (lightweight re-declaration for consistency)
  Container(web_spa, "CourtierPro Web App", "React 18 + Vite", "Role-based SPA (Client / Broker / Admin); i18n en/fr.", $sprite="react", $tags="framework-react")
  ContainerDb(main_db, "courtierpro-db", "PostgreSQL 15", "Shared schema with bounded-context-owned tables.", $sprite="postgresql", $tags="storage-postgres")

  Container_Boundary(backend_api, "CourtierPro Backend API (Spring Boot 3)", $tags="microService-java") {

    ' ==== USER MANAGEMENT ====
    Component(CurrentUserController, "CurrentUserController", "REST Controller", "/api/me – current user’s view")
    Component(AdminUserController, "AdminUserController", "REST Controller", "/api/admin/users/** – admin management APIs")
    Component(BrokerController, "BrokerController", "REST Controller", "/api/v1/brokers/** - broker management")
    Component(OrganizationSettingsController, "OrganizationSettingsController", "REST Controller", "/api/v1/organization-settings - org-wide config")
    Component(UserProvisioningService, "UserProvisioningService", "Application Service", "Syncs Auth0 users to DB")
    Component(UserAccountRepository, "UserAccountRepository", "Spring Data Repository", "CRUD for UserAccount aggregate")
    Component(Auth0ManagementClient, "Auth0ManagementClient", "Infrastructure Adapter", "Delegates identity operations to Auth0")

    ' ==== TRANSACTION MANAGEMENT ====
    Component(TransactionController, "TransactionController", "REST Controller", "/api/v1/transactions/** – general transaction APIs")
    Component(ClientTransactionController, "ClientTransactionController", "REST Controller", "/clients/{clientId}/transactions – client views")
    Component(TransactionStageController, "TransactionStageController", "REST Controller", "/api/v1/transactions/{id}/stage – stage transitions")
    Component(TransactionService, "TransactionService", "Application Service", "Transaction lifecycle and queries")
    Component(TimelineService, "TimelineService", "Domain/Application Service", "Stage changes and timeline entries")
    Component(TransactionRepository, "TransactionRepository", "Spring Data Repository", "CRUD for Transaction aggregate")

    ' ==== DOCUMENT MANAGEMENT ====
    Component(DocumentController, "DocumentController", "REST Controller", "/api/v1/transactions/{id}/documents/** – broker & system")
    Component(GlobalDocumentController, "GlobalDocumentController", "REST Controller", "/documents/** - download/view access")
    Component(DocumentService, "DocumentService", "Application Service", "Document & DocumentVersion workflows")
    Component(DocumentRepository, "DocumentRepository", "Spring Data Repository", "CRUD for Document aggregate")
    Component(ObjectStorageService, "ObjectStorageService", "Infrastructure Adapter", "Pre-signed URLs and Cloudflare R2 interactions (S3-compatible)")

    ' ==== APPOINTMENTS ====
    Component(AppointmentController, "AppointmentController", "REST Controller", "/api/v1/appointments/** – appointments")
    Component(AppointmentService, "AppointmentService", "Application Service", "Appointment lifecycle & status transitions")
    Component(AppointmentRepository, "AppointmentRepository", "Spring Data Repository", "CRUD for Appointment aggregate")

    ' ==== ANALYTICS / DASHBOARD ====
    Component(DashboardController, "DashboardController", "REST Controller", "/api/v1/dashboard/** – consolidated views")
    Component(DashboardService, "DashboardService", "Application Service", "Computes broker/client KPIs")
    Component(BrokerMetricsRepository, "BrokerMetricsRepository", "Spring Data Repository", "CRUD for BrokerMetricsSnapshot")

    Component(AnalyticsController, "AnalyticsController", "REST Controller", "/api/v1/analytics/** (Future)")
    Component(AnalyticsService, "AnalyticsService", "Application Service", "Future advanced analytics")

    ' ==== NOTIFICATIONS ====
    Component(NotificationController, "NotificationController", "REST Controller", "/api/v1/notifications/**")
    Component(NotificationService, "NotificationService", "Application Service", "Composes and logs notifications")
    Component(NotificationRepository, "NotificationRepository", "Spring Data Repository", "Notification aggregate persistence")
    Component(JavaMailSender, "JavaMailSender", "Infrastructure Adapter", "Sends email via Amazon SES/SMTP")

    ' ==== AUDIT & SEARCH ====
    Component(SearchController, "SearchController", "REST Controller", "/api/v1/search/**")
    Component(FeedbackController, "FeedbackController", "REST Controller", "/api/v1/feedback/**")
    
    Component(SystemAlertController, "SystemAlertController", "REST Controller", "/api/v1/system-alerts/**")
    Component(AuditControllers, "AuditControllers", "REST Controllers", "AdminResourceController, LoginAuditController,\nLogoutAuditController, PasswordResetAudit etc.")
    
    Component(SearchService, "SearchService", "Application Service", "Search logic")
    Component(FeedbackService, "FeedbackService", "Application Service", "Feedback submission")
    Component(AuditService, "AuditService", "Application Service", "Unified audit logging & retrieval")
    Component(AuditRepositories, "AuditRepositories", "Spring Data Repositories", "CRUD for audit tables")

    ' ==== CROSS-CUTTING ====
    Component(DomainEventPublisher, "DomainEventPublisher", "Infrastructure", "Publishes domain events in-process")
  }
}

' Relationships (high-level, internal wiring)

' Domain events
Rel(TransactionService, DomainEventPublisher, "publishes TransactionStageChanged")
Rel(DocumentService, DomainEventPublisher, "publishes DocumentStatusUpdated")
Rel(AppointmentService, DomainEventPublisher, "publishes AppointmentStatusChanged")

Rel(TransactionService, NotificationService, "publishes notifications on stage change")
Rel(DocumentService, NotificationService, "notifies brokers/clients of document updates")
Rel(AppointmentService, NotificationService, "notifies participants of appointment status")

Rel(web_spa, CurrentUserController, "Uses", "JSON/REST/HTTPS", $tags="purple-line")
Rel(web_spa, TransactionController, "Uses", "JSON/REST/HTTPS", $tags="purple-line")
Rel(web_spa, DocumentController, "Uses", "JSON/REST/HTTPS", $tags="purple-line")
Rel(web_spa, AppointmentController, "Uses", "JSON/REST/HTTPS", $tags="purple-line")
Rel(web_spa, DashboardController, "Uses", "JSON/REST/HTTPS", $tags="purple-line")
Rel(web_spa, AdminUserController, "Uses", "JSON/REST/HTTPS", $tags="purple-line")
Rel(web_spa, NotificationController, "Uses", "JSON/REST/HTTPS", $tags="purple-line")

Rel(CurrentUserController, UserProvisioningService, "calls")
Rel(AdminUserController, UserProvisioningService, "calls")
Rel(BrokerController, UserProvisioningService, "calls")
Rel(OrganizationSettingsController, UserAccountRepository, "uses (via service?)")
Rel(UserProvisioningService, UserAccountRepository, "uses")
Rel(UserProvisioningService, Auth0ManagementClient, "syncs identities")

Rel(TransactionController, TransactionService, "calls")
Rel(ClientTransactionController, TransactionService, "calls")
Rel(TransactionStageController, TransactionService, "calls")
Rel(TransactionService, TransactionRepository, "uses")
Rel(TransactionService, TimelineService, "delegates stage changes")

Rel(DocumentController, DocumentService, "calls")
Rel(GlobalDocumentController, DocumentService, "calls")
Rel(DocumentService, DocumentRepository, "uses")
Rel(DocumentService, ObjectStorageService, "uses")

Rel(AppointmentController, AppointmentService, "calls")
Rel(AppointmentService, AppointmentRepository, "uses")

Rel(DashboardController, DashboardService, "calls")
Rel(DashboardService, BrokerMetricsRepository, "reads")
Rel(DashboardService, TransactionRepository, "reads")

Rel(NotificationController, NotificationService, "calls")
Rel(NotificationService, NotificationRepository, "persists")
Rel(NotificationService, JavaMailSender, "uses")

Rel(web_spa, SearchController, "Uses /api/search", "JSON/REST/HTTPS", $tags="purple-line")
Rel(web_spa, FeedbackController, "Uses /api/v1/feedback", "JSON/REST/HTTPS", $tags="purple-line")
Rel(web_spa, AuditControllers, "Uses (Admin)", "JSON/REST/HTTPS", $tags="purple-line")

Rel(SearchController, SearchService, "calls") 
Rel(FeedbackController, FeedbackService, "calls")
Rel(SystemAlertController, AuditService, "calls")
Rel(AuditControllers, AuditService, "calls")
Rel(AuditService, AuditRepositories, "uses")
' Note: FeedbackService integrates with GitHub Issues (not shown in Db for now)

Rel(UserAccountRepository, main_db, "Reads/Writes", "JDBC/R2DBC")
Rel(TransactionRepository, main_db, "Reads/Writes", "JDBC/R2DBC")
Rel(DocumentRepository, main_db, "Reads/Writes", "JDBC/R2DBC")
Rel(AppointmentRepository, main_db, "Reads/Writes", "JDBC/R2DBC")
Rel(NotificationRepository, main_db, "Reads/Writes", "JDBC/R2DBC")
Rel(BrokerMetricsRepository, main_db, "Reads/Writes", "JDBC/R2DBC")
Rel(AuditRepositories, main_db, "Reads/Writes", "JDBC/R2DBC")

SHOW_LEGEND()
@enduml
