@startuml
hide circle
top to bottom direction
scale 0.2

!define ENTITY(x) class x << Entity >>
!define AGGREGATE_ROOT(x) class x << Aggregate Root >>
!define VALUE_OBJECT(x) class x << Value Object >>
!define ENUM(x) class x << Enum >>
!pragma useVerticalIf on

skinparam dpi 350
skinparam packageStyle rectangle
skinparam rectangle {
  BackgroundColor #f7f4eb
  BorderColor Black
}
skinparam class {
  BackgroundColor White
  BorderColor Black
}
skinparam stereotypeCBackgroundColor #e0e0e0
skinparam stereotypeCBorderColor Black

skinparam defaultFontName "Segoe UI"
skinparam defaultFontSize 16
skinparam classFontSize 16
skinparam noteFontSize 14
skinparam packageTitleFontSize 18
skinparam titleFontSize 22

rectangle "CourtierPro Domain" as Domain {

  '======================
  ' USER MANAGEMENT CONTEXT
  '======================
  package "User Management" as UserBC <<Rectangle>> #LightBlue {

    AGGREGATE_ROOT(UserAccount) #lightblue {
      userId: UUID
      auth0UserId: String
      email: String
      firstName: String
      lastName: String
      role: UserRole
      active: Boolean
      preferredLanguage: String
      createdAt: DateTime
      updatedAt: DateTime
    }

    ENUM(UserRole) {
      ADMIN
      BROKER
      CLIENT
    }

    ' Intra-context links
    UserAccount --> UserRole

    note bottom of UserAccount
      Invariants:
      • auth0UserId must be unique.
      • email must be unique.
      • Single entity for all system users (Unified Identity).
    end note

    AGGREGATE_ROOT(OrganizationSettings) #lightblue {
      orgId: UUID
      defaultLanguage: String
      inviteSubjectEn: String
      inviteBodyEn: String
      inviteSubjectFr: String
      inviteBodyFr: String
    }
  }


  '======================
  ' TRANSACTION MANAGEMENT CONTEXT
  '======================
  package "Transaction Management" as TransactionBC <<Rectangle>> #LightYellow {

    AGGREGATE_ROOT(Transaction) #lightyellow {
      transactionId: UUID
      propertyAddress: PropertyAddress
      clientRef: UserRef
      brokerRef: UserRef
      side: TransactionSideEnum
      buyerStage: BuyerTransactionStageEnum?
      sellerStage: SellerTransactionStageEnum?
      timeline: List<TimelineEntry>
      openedAt: DateTime
      closedAt: DateTime
      status: TransactionStatusEnum
    }

    ENTITY(TimelineEntry) #lightpink {
      timelineEntryId: UUID
      type: TimelineEntryTypeEnum
      note: String
      occurredAt: DateTime
      addedByUserId: UUID
      buyerStage: BuyerTransactionStageEnum?
      sellerStage: SellerTransactionStageEnum?
    }
    
    ENTITY(TransactionParticipant) #lightpink {
      participantId: UUID
      name: String
      role: String
      email: String
      phone: String
    }
    
    ENTITY(PinnedTransaction) #lightpink {
       pinnedId: UUID
       brokerRef: UserRef
       transactionId: UUID
       pinnedAt: DateTime
    }

    VALUE_OBJECT(UserRef) #Bisque {
      userId: UUID // (Internal UUID)
      snapshotName: String
      snapshotEmail: String
    }

    VALUE_OBJECT(PropertyAddress) #Bisque {
      street: String
      city: String
      province: String
      postalCode: String
    }

    ENUM(TransactionSideEnum) {
      BUY_SIDE
      SELL_SIDE
    }

    ENUM(BuyerTransactionStageEnum) {
      BUYER_PREQUALIFY_FINANCIALLY
      BUYER_SHOP_FOR_PROPERTY
      BUYER_SUBMIT_OFFER
      BUYER_OFFER_ACCEPTED
      BUYER_HOME_INSPECTION
      BUYER_FINANCING_FINALIZED
      BUYER_FIRST_NOTARY_APPOINTMENT
      BUYER_SECOND_NOTARY_APPOINTMENT
      BUYER_OCCUPANCY
      BUYER_TERMINATED
    }

    ENUM(SellerTransactionStageEnum) {
      SELLER_INITIAL_CONSULTATION
      SELLER_LISTING_PUBLISHED
      SELLER_REVIEW_OFFERS
      SELLER_ACCEPT_BEST_OFFER
      SELLER_CONDITIONS_MET
      SELLER_NOTARY_COORDINATION
      SELLER_NOTARY_APPOINTMENT
      SELLER_HANDOVER_KEYS
      SELLER_TERMINATED
    }

    ENUM(TransactionStatusEnum) {
      ACTIVE
      CLOSED_SUCCESSFULLY
      TERMINATED_EARLY
    }

    ENUM(TimelineEntryTypeEnum) {
      STAGE_CHANGE
      NOTE
    }

    ' Intra-context links
    Transaction "1" *-- "1" PropertyAddress
    Transaction "1" *-- "2" UserRef
    Transaction "1" *-- "0..*" TimelineEntry
    Transaction "1" *-- "0..*" TransactionParticipant
    Transaction --> TransactionSideEnum
    Transaction --> BuyerTransactionStageEnum
    Transaction --> SellerTransactionStageEnum
    Transaction --> TransactionStatusEnum
    
    Transaction "1" -- "0..*" PinnedTransaction : has >
    PinnedTransaction --> UserRef

    TimelineEntry --> TimelineEntryTypeEnum
    TimelineEntry --> BuyerTransactionStageEnum
    TimelineEntry --> SellerTransactionStageEnum

    note bottom of Transaction
      Invariants:
      • Each Transaction belongs to exactly one Client (UserAccount) and is
        primarily handled by exactly one Broker (UserAccount).
      • side determines stage usage.
    end note
  }


  '======================
  ' DOCUMENT MANAGEMENT CONTEXT
  '======================
  package "Document Management" as DocumentBC <<Rectangle>> #LightGreen {

    AGGREGATE_ROOT(DocumentRequest) #lightgreen {
      requestId: UUID
      transactionRef: TransactionRef
      side: TransactionSideEnum
      docType: DocumentTypeEnum
      customTitle: String
      status: DocumentStatusEnum
      expectedFrom: DocumentPartyEnum
      submittedDocuments: List<SubmittedDocument>
      brokerNotes: String
      lastUpdatedAt: DateTime
      visibleToClient: Boolean
    }

    VALUE_OBJECT(TransactionRef) #Bisque {
      transactionId: UUID
      clientId: UUID
      side: TransactionSideEnum
    }

    VALUE_OBJECT(StorageObjectRef) #Bisque {
      s3Key: String
      fileName: String
      mimeType: String
    }

    ENUM(DocumentPartyEnum) {
      BUYER
      SELLER
      BROKER
      LENDER
      NOTARY
      INSPECTOR
      OTHER
    }

    VALUE_OBJECT(UploadedByRef) #Bisque {
      party: DocumentPartyEnum
      userId: UUID?
      externalName: String?
    }

    ENTITY(SubmittedDocument) #lightpink {
      documentId: UUID
      uploadedAt: DateTime
      uploadedBy: UploadedByRef
      storageObject: StorageObjectRef
    }

    ENUM(DocumentTypeEnum) {
      MORTGAGE_PRE_APPROVAL_LETTER
      BUYER_PROOF_OF_FUNDS
      BUYER_PROOF_OF_INCOME
      BUYER_ID_DOCUMENT
      CERTIFICATE_OF_LOCATION
      SELLER_DECLARATION
      MLS_LISTING
      PROMISE_TO_PURCHASE
      OFFER_ANNEX
      ACKNOWLEDGED_SELLER_DECLARATION
      INSPECTION_REPORT
      FINAL_MORTGAGE_APPROVAL_LETTER
      INSURANCE_CONFIRMATION_LETTER
      MORTGAGE_DEED
      DEED_OF_SALE
      ACCEPTED_OFFER_PACKAGE
      PRIOR_DEEDS
      CERTIFIED_COPY_OF_DEED
      CMA_REPORT
      MUNICIPAL_TAX_BILL
      SCHOOL_TAX_BILL
      MORTGAGE_BALANCE_STATEMENT
      OTHER
    }

    ENUM(DocumentStatusEnum) {
      REQUESTED
      SUBMITTED
      APPROVED
      NEEDS_REVISION
    }

    ' Intra-context links
    DocumentRequest "1" *-- "1" TransactionRef
    DocumentRequest "1" *-- "0..*" SubmittedDocument
    SubmittedDocument "1" *-- "1" StorageObjectRef

    DocumentRequest --> DocumentTypeEnum
    DocumentRequest --> DocumentStatusEnum
    DocumentRequest --> DocumentPartyEnum

    SubmittedDocument --> DocumentPartyEnum
  }


  '======================
  ' APPOINTMENT MANAGEMENT CONTEXT
  '======================
  package "Appointment Management" as AppointmentBC <<Rectangle>> #LightSalmon {

    AGGREGATE_ROOT(Appointment) #lightsalmon {
      appointmentId: UUID
      transactionId: UUID
      clientId: UUID
      brokerId: UUID
      appointmentType: AppointmentTypeEnum
      scheduledStart: DateTime
      scheduledEnd: DateTime
      status: AppointmentStatusEnum
      details: String
      lastModifiedByUserId: UUID
      reminderPolicy: ReminderPolicy
    }
    
    VALUE_OBJECT(ReminderPolicy) #Bisque {
      sendEmailReminder: Boolean
      minutesBefore: Integer
    }

    ENUM(AppointmentTypeEnum) {
      BUYER_SHOWING
      LISTING_VISIT
      INSPECTION
      NOTARY_MEETING
      OTHER
    }

    ENUM(AppointmentStatusEnum) {
      PENDING_BROKER_CONFIRMATION
      CONFIRMED
      CANCELLED
      RESCHEDULE_PROPOSED
      DECLINED
      COMPLETED
    }

    ' Intra-context links
    Appointment --> AppointmentTypeEnum
    Appointment --> AppointmentStatusEnum

    note bottom of Appointment
      Future Feature.
      Invariants:
      • scheduledStart must be in the future when status is
        PENDING_BROKER_CONFIRMATION or CONFIRMED.
    end note
  }


  '======================
  ' NOTIFICATIONS CONTEXT
  '======================
  package "Notifications" as NotificationsBC <<Rectangle>> #Thistle {

    AGGREGATE_ROOT(Notification) #Thistle {
      id: Long
      publicId: UUID
      recipientId: String
      title: String
      message: String
      type: NotificationType
      category: NotificationCategory
      isRead: Boolean
      relatedTransactionId: String // (Holds UUID)
      createdAt: DateTime
    }

    ENUM(NotificationType) {
      GENERAL
      BROADCAST
    }
    
    ENUM(NotificationCategory) {
      GENERAL
      TRANSACTION
      DOCUMENT
      APPOINTMENT
    }

    ' Intra-context links
    Notification --> NotificationType
    Notification --> NotificationCategory

    note bottom of Notification
      Invariants:
      • id is internal DB PK; publicId corresponds to the client-facing UUID.
      • recipientId links to UserAccount.userId (Internal UUID).
    end note
  }


  '======================
  ' ANALYTICS CONTEXT
  '======================
  package "Analytics" as AnalyticsBC <<Rectangle>> #LightGray {

    AGGREGATE_ROOT(BrokerMetricsSnapshot) #lightgray {
      snapshotId: UUID
      brokerUserId: UUID
      capturedAt: DateTime
      activeTransactionsCount: Integer
      activeBuyerTransactionsCount: Integer
      activeSellerTransactionsCount: Integer
      avgTimeToCloseDays: Decimal
      documentsAwaitingReviewCount: Integer
      pendingAppointmentsCount: Integer
    }

    note bottom of BrokerMetricsSnapshot
      Future Feature.
      Computed from live operational data.
    end note
  }


  '======================
  ' CROSS-CONTEXT RELATIONSHIPS
  '======================

  ' TRANSACTION ↔ USER MANAGEMENT
  TransactionBC.Transaction --> UserBC.UserAccount : "Client (Buyer/Seller)"
  TransactionBC.Transaction --> UserBC.UserAccount : "Broker"
  TransactionBC.PinnedTransaction --> UserBC.UserAccount : "Broker"

  ' DOCUMENT MANAGEMENT ↔ TRANSACTION MANAGEMENT
  DocumentBC.DocumentRequest --> TransactionBC.Transaction

  ' APPOINTMENT MANAGEMENT ↔ TRANSACTION MANAGEMENT
  AppointmentBC.Appointment --> TransactionBC.Transaction
  AppointmentBC.Appointment --> UserBC.UserAccount : "Participants"

  ' NOTIFICATIONS ↔ DOCUMENT / TRANSACTION / APPOINTMENT
  NotificationsBC.Notification ..> DocumentBC.DocumentRequest : "Refers to"
  NotificationsBC.Notification ..> TransactionBC.Transaction : "Refers to"
  NotificationsBC.Notification ..> AppointmentBC.Appointment : "Refers to"
  NotificationsBC.Notification --> UserBC.UserAccount : "Recipient"

  ' ANALYTICS ↔ TRANSACTION / DOCUMENT / APPOINTMENT / USER
  AnalyticsBC.BrokerMetricsSnapshot --> TransactionBC.Transaction
  AnalyticsBC.BrokerMetricsSnapshot --> UserBC.UserAccount : "Broker"

}

@enduml
