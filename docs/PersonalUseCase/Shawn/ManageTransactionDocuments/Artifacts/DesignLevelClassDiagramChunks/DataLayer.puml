@startuml DataLayer
skinparam classAttributeIconSize 0

title Data Layer

package "Data Layer" #LightYellow {
  interface DocumentRepository {
    + findByDocumentId(documentId): Optional<Document>
    + findByTransactionRefTransactionId(transactionId): List<Document>
    + findByTransactionRefClientId(clientId): List<Document>
    + findByStatus(status): List<Document>
    + countByStatus(status): Long
  }
  
  interface TransactionRepository {
    + findByTransactionId(transactionId): Optional<Transaction>
    + findByClientId(clientId): List<Transaction>
  }
  
  class Document <<Entity>> {
    - id: Long
    - documentId: UUID
    - transactionRef: TransactionRef
    - docType: DocumentTypeEnum
    - customTitle: String
    - status: DocumentStatusEnum
    - expectedFrom: DocumentPartyEnum
    - relatedBuyerStage: BuyerStage
    - relatedSellerStage: SellerStage
    - stage: StageEnum
    - versions: List<DocumentVersion>
    - brokerNotes: String
    - visibleToClient: boolean
    - lastUpdatedAt: LocalDateTime
    - deletedAt: LocalDateTime
    - deletedBy: UUID
    --
    + isVisibleToClient(): boolean
    + getVisibleToClient(): boolean
  }
  
  class DocumentVersion <<Entity>> {
    - id: Long
    - versionId: UUID
    - uploadedAt: LocalDateTime
    - uploadedBy: UploadedBy
    - storageObject: StorageObject
    - document: Document
    - deletedAt: LocalDateTime
    - deletedBy: UUID
  }
  
  class TransactionRef <<Value Object>> {
    - transactionId: UUID
    - clientId: UUID
    - side: TransactionSideEnum
  }
  
  class StorageObject <<Value Object>> {
    - s3Key: String
    - fileName: String
    - mimeType: String
  }
  
  class UploadedBy <<Value Object>> {
    - party: DocumentPartyEnum
    - userId: UUID
    - externalName: String
  }
  
  ' Intra-package relationships
  DocumentRepository ..> Document : persists
  Document "1" *-- "1" TransactionRef : contains
  Document "1" *-- "0..*" DocumentVersion : contains
  DocumentVersion "1" *-- "1" StorageObject : contains
  DocumentVersion "1" *-- "1" UploadedBy : contains
}

@enduml
