@startuml DesignLevelSequenceDiagram
!pragma teoz true

title Design Level Sequence Diagram: Submit Document Flow

actor "Client" as Client
participant "DocumentsCenter\n<<React Component>>" as UI
participant "ApiClient\n<<Axios>>" as ApiClient
participant "DocumentController\n<<REST Controller>>" as Controller
participant "DocumentService\n<<Application Service>>" as Service
participant "TransactionRepository\n<<Repository>>" as TxnRepo
participant "DocumentRepository\n<<Repository>>" as DocRepo
participant "ObjectStorageService\n<<Infrastructure>>" as S3
participant "NotificationService\n<<Application Service>>" as Notif
database "PostgreSQL" as DB
database "Cloudflare R2" as R2Store

== Client Uploads Document ==

Client -> UI: selectFile(file)
activate UI
UI -> UI: validateFileClient(file)
UI --> Client: showUploadPreview

Client -> UI: confirmUpload()
UI -> ApiClient: POST /transactions/{id}/documents/{reqId}/submit
activate ApiClient
ApiClient -> Controller: submitDocument(transactionId, requestId, file)
activate Controller

Controller -> Controller: resolveUserId(request)
Controller -> Controller: determineUploaderType(jwt)
Controller -> Service: submitDocument(transactionId, requestId, file, userId, uploaderType)
activate Service

' Validate Transaction Access
Service -> TxnRepo: findById(transactionId)
activate TxnRepo
TxnRepo -> DB: SELECT * FROM transactions WHERE id = ?
DB --> TxnRepo: Transaction
TxnRepo --> Service: Transaction
deactivate TxnRepo

Service -> Service: validateUserAccess(transaction, userId)

' Validate Document Request
Service -> DocRepo: findByRequestId(requestId)
activate DocRepo
DocRepo -> DB: SELECT * FROM documents WHERE document_id = ?
DB --> DocRepo: Document
DocRepo --> Service: Document
deactivate DocRepo

Service -> Service: validateCanSubmit(document)

' Validate File
Service -> Service: validateFile(file)
note right: Check file type, size constraints

' Upload to Cloudflare R2
Service -> S3: uploadFile(transactionId, requestId, file)
activate S3
S3 -> R2Store: PutObject(bucket, key, fileContent)
R2Store --> S3: uploadResult
S3 --> Service: StorageObject(s3Key, fileName, mimeType)
deactivate S3

' Create DocumentVersion
Service -> Service: createDocumentVersion(document, storageObject, uploadedBy)

' Update Document
Service -> Service: updateStatus(SUBMITTED)
Service -> DocRepo: save(document)
activate DocRepo
DocRepo -> DB: UPDATE documents SET status = 'SUBMITTED' ...
DocRepo -> DB: INSERT INTO document_versions ...
DB --> DocRepo: savedEntity
DocRepo --> Service: updatedDocument
deactivate DocRepo

' Send Notification
Service -> Notif: notifyDocumentSubmitted(document)
activate Notif
Notif -> Notif: createNotification(brokerId, DOCUMENT, message)
Notif -> DB: INSERT INTO notifications ...
Notif -> Notif: sendEmail(brokerEmail, template)
Notif --> Service: void
deactivate Notif

' Map to DTO
Service -> Service: mapToDTO(document)
Service --> Controller: DocumentResponseDTO
deactivate Service

Controller --> ApiClient: HTTP 200 + JSON body
deactivate Controller
ApiClient --> UI: response
deactivate ApiClient

UI -> UI: refreshDocumentsList()
UI --> Client: showSuccessToast
deactivate UI

@enduml
