@startuml DDDDomainModel
hide circle
top to bottom direction
scale 0.2

!define ENTITY(x) class x << Entity >>
!define AGGREGATE_ROOT(x) class x << Aggregate Root >>
!define VALUE_OBJECT(x) class x << Value Object >>
!define ENUM(x) class x << Enum >>
!pragma useVerticalIf on

skinparam dpi 350
skinparam packageStyle rectangle
skinparam rectangle {
  BackgroundColor #f7f4eb
  BorderColor Black
}
skinparam class {
  BackgroundColor White
  BorderColor Black
}
skinparam stereotypeCBackgroundColor #e0e0e0
skinparam stereotypeCBorderColor Black

skinparam defaultFontName "Segoe UI"
skinparam defaultFontSize 16
skinparam classFontSize 16
skinparam noteFontSize 14
skinparam packageTitleFontSize 18
skinparam titleFontSize 22

rectangle "CourtierPro Domain" as Domain {

  '======================
  ' USER MANAGEMENT CONTEXT
  '======================
  package "User Management" as UserBC <<Rectangle>> #LightBlue {

    AGGREGATE_ROOT(UserAccount) #lightblue {
      id: UUID
      auth0UserId: String
      email: String
      firstName: String
      lastName: String
      role: UserRole
      active: Boolean
      preferredLanguage: String
      emailNotificationsEnabled: Boolean
      inAppNotificationsEnabled: Boolean
      createdAt: Instant
      updatedAt: Instant
    }

    ENUM(UserRole) {
      ADMIN
      BROKER
      CLIENT
    }

    UserAccount --> UserRole

    note bottom of UserAccount
      Invariants:
      * auth0UserId must be unique.
      * email must be unique.
      * Single entity for all system users (Unified Identity).
      * preferredLanguage drives bilingual email templates.
    end note

    AGGREGATE_ROOT(OrganizationSettings) #lightblue {
      orgId: UUID
      defaultLanguage: String
      inviteSubjectEn: String
      inviteBodyEn: String
      inviteSubjectFr: String
      inviteBodyFr: String
      documentRequestSubjectEn: String
      documentRequestBodyEn: String
      documentReviewSubjectEn: String
      documentReviewBodyEn: String
    }
  }


  '======================
  ' TRANSACTION MANAGEMENT CONTEXT
  '======================
  package "Transaction Management" as TransactionBC <<Rectangle>> #LightYellow {

    AGGREGATE_ROOT(Transaction) #lightyellow {
      transactionId: UUID
      propertyAddress: PropertyAddress
      clientRef: UserRef
      brokerRef: UserRef
      side: TransactionSideEnum
      buyerStage: BuyerTransactionStageEnum?
      sellerStage: SellerTransactionStageEnum?
      timeline: List<TimelineEntry>
      participants: List<TransactionParticipant>
      openedAt: DateTime
      closedAt: DateTime
      status: TransactionStatusEnum
      commissionRate: Decimal
      archived: Boolean
    }

    ENTITY(TimelineEntry) #lightpink {
      timelineEntryId: UUID
      type: TimelineEntryTypeEnum
      note: String
      timestamp: Instant
      addedByUserId: UUID
      buyerStage: BuyerTransactionStageEnum?
      sellerStage: SellerTransactionStageEnum?
    }

    ENTITY(TransactionParticipant) #lightpink {
      participantId: UUID
      name: String
      role: String
      email: String
      phoneNumber: String
    }

    ENTITY(PinnedTransaction) #lightpink {
       id: Long
       brokerRef: UserRef
       transactionId: UUID
       pinnedAt: DateTime
    }

    ENTITY(Property) #lightpink {
      propertyId: UUID
      address: PropertyAddress
      askingPrice: Decimal
      propertyType: String
      status: PropertyStatus
      features: String
    }

    ENTITY(PropertyOffer) #lightpink {
      offerId: UUID
      propertyId: UUID
      offerAmount: Decimal
      status: OfferStatus
      expiryDate: LocalDate
      offerRound: Integer
    }

    ENTITY(Offer) #lightpink {
      offerId: UUID
      transactionId: UUID
      buyerName: String
      offerAmount: Decimal
      status: OfferStatus
      expiryDate: LocalDate
    }

    ENTITY(Condition) #lightpink {
      conditionId: UUID
      transactionId: UUID
      type: String
      description: String
      status: ConditionStatus
      deadlineDate: LocalDate
    }

    VALUE_OBJECT(UserRef) #Bisque {
      userId: UUID
      snapshotName: String
      snapshotEmail: String
    }

    VALUE_OBJECT(PropertyAddress) #Bisque {
      street: String
      city: String
      province: String
      postalCode: String
    }

    ENUM(TransactionSideEnum) {
      BUY_SIDE
      SELL_SIDE
    }

    ENUM(BuyerTransactionStageEnum) {
      FINANCIAL_PREPARATION
      PROPERTY_SEARCH
      OFFER_AND_NEGOTIATION
      FINANCING_AND_CONDITIONS
      NOTARY_AND_SIGNING
      POSSESSION
    }

    ENUM(SellerTransactionStageEnum) {
      INITIAL_CONSULTATION
      PUBLISH_LISTING
      OFFER_AND_NEGOTIATION
      FINANCING_AND_CONDITIONS
      NOTARY_AND_SIGNING
      HANDOVER
    }

    ENUM(TransactionStatusEnum) {
      ACTIVE
      CLOSED_SUCCESSFULLY
      TERMINATED_EARLY
    }

    ENUM(TimelineEntryTypeEnum) {
      STAGE_CHANGE
      NOTE
      DOCUMENT_EVENT
      APPOINTMENT_EVENT
    }

    ' Intra-context links
    Transaction "1" *-- "1" PropertyAddress
    Transaction "1" *-- "2" UserRef
    Transaction "1" *-- "0..*" TimelineEntry
    Transaction "1" *-- "0..*" TransactionParticipant
    Transaction "1" *-- "0..*" Property : (buy-side)
    Transaction "1" *-- "0..*" Offer : (sell-side)
    Transaction "1" *-- "0..*" Condition
    Property "1" *-- "0..*" PropertyOffer
    Transaction --> TransactionSideEnum
    Transaction --> BuyerTransactionStageEnum
    Transaction --> SellerTransactionStageEnum
    Transaction --> TransactionStatusEnum

    Transaction "1" -- "0..*" PinnedTransaction : has >
    PinnedTransaction --> UserRef

    TimelineEntry --> TimelineEntryTypeEnum

    note bottom of Transaction
      Invariants:
      * Each Transaction belongs to exactly one Client and one Broker.
      * side determines which stage enum is active.
      * Only ACTIVE transactions can advance stages.
    end note
  }


  '======================
  ' DOCUMENT MANAGEMENT CONTEXT
  '======================
  package "Document Management" as DocumentBC <<Rectangle>> #LightGreen {

    AGGREGATE_ROOT(Document) #lightgreen {
      documentId: UUID
      transactionRef: TransactionRef
      docType: DocumentTypeEnum
      customTitle: String
      status: DocumentStatusEnum
      expectedFrom: DocumentPartyEnum
      flow: DocumentFlowEnum
      requiresSignature: Boolean
      stage: StageEnum
      templateKey: String
      autoGenerated: Boolean
      versions: List<DocumentVersion>
      brokerNotes: String
      visibleToClient: Boolean
      dueDate: DateTime
      createdAt: DateTime
      lastUpdatedAt: DateTime
      deletedAt: DateTime
      deletedBy: UUID
    }

    ENTITY(DocumentVersion) #lightpink {
      versionId: UUID
      uploadedAt: DateTime
      uploadedBy: UploadedBy
      storageObject: StorageObject
      deletedAt: DateTime
      deletedBy: UUID
    }

    ENTITY(TransactionStageChecklistState) #lightpink {
      transactionId: UUID
      stage: StageEnum
      itemKey: String
      manualChecked: Boolean
      manualCheckedBy: UUID
      autoChecked: Boolean
      autoCheckedAt: DateTime
    }

    ENTITY(DocumentConditionLink) #lightpink {
      conditionId: UUID
      documentId: UUID
      createdAt: DateTime
    }

    VALUE_OBJECT(TransactionRef) #Bisque {
      transactionId: UUID
      clientId: UUID
      side: TransactionSide
    }

    VALUE_OBJECT(StorageObject) #Bisque {
      s3Key: String
      fileName: String
      mimeType: String
      sizeBytes: Long
    }

    VALUE_OBJECT(UploadedBy) #Bisque {
      uploaderType: UploadedByRefEnum
      party: DocumentPartyEnum
      uploaderId: UUID
      externalName: String
    }

    VALUE_OBJECT(StageDocumentTemplate) #Bisque {
      itemKey: String
      label: String
      docType: DocumentTypeEnum
      flow: DocumentFlowEnum
      requiresSignature: Boolean
    }

    ENUM(DocumentFlowEnum) {
      REQUEST
      UPLOAD
    }

    ENUM(DocumentTypeEnum) {
      MORTGAGE_PRE_APPROVAL
      MORTGAGE_APPROVAL
      PROOF_OF_FUNDS
      PROOF_OF_INCOME
      ID_VERIFICATION
      GOVERNMENT_ID_1
      GOVERNMENT_ID_2
      EMPLOYMENT_LETTER
      PAY_STUBS
      CREDIT_REPORT
      BROKERAGE_CONTRACT
      CERTIFICATE_OF_LOCATION
      PROMISE_TO_PURCHASE
      ACCEPTED_PROMISE_TO_PURCHASE
      SELLERS_DECLARATION
      ACKNOWLEDGED_SELLERS_DECLARATION
      INSPECTION_REPORT
      INSURANCE_LETTER
      NOTARY_CONTACT_SHEET
      COMPARATIVE_MARKET_ANALYSIS
      MUNICIPAL_TAX_BILLS
      MORTGAGE_BALANCE_STATEMENT
      SCHOOL_TAX_BILLS
      CURRENT_DEED_OF_SALE
      BANK_STATEMENT
      OTHER
    }

    ENUM(DocumentStatusEnum) {
      DRAFT
      REQUESTED
      SUBMITTED
      APPROVED
      NEEDS_REVISION
      REJECTED
    }

    ENUM(DocumentPartyEnum) {
      BUYER
      SELLER
      BROKER
      LENDER
      NOTARY
      INSPECTOR
      CLIENT
      OTHER
    }

    ENUM(UploadedByRefEnum) {
      CLIENT
      BROKER
      SYSTEM
      EXTERNAL
    }

    ENUM(StageEnum) {
      FINANCIAL_PREPARATION
      PROPERTY_SEARCH
      OFFER_AND_NEGOTIATION
      FINANCING_AND_CONDITIONS
      NOTARY_AND_SIGNING
      POSSESSION
      INITIAL_CONSULTATION
      PUBLISH_LISTING
      HANDOVER
    }

    ' Intra-context links
    Document "1" *-- "1" TransactionRef
    Document "1" *-- "0..*" DocumentVersion
    Document "1" -- "0..*" DocumentConditionLink
    DocumentVersion "1" *-- "1" StorageObject
    DocumentVersion "1" *-- "1" UploadedBy

    Document --> DocumentTypeEnum
    Document --> DocumentStatusEnum
    Document --> DocumentPartyEnum
    Document --> DocumentFlowEnum
    Document --> StageEnum
    UploadedBy --> UploadedByRefEnum
    UploadedBy --> DocumentPartyEnum

    TransactionStageChecklistState --> StageEnum
    StageDocumentTemplate --> DocumentTypeEnum
    StageDocumentTemplate --> DocumentFlowEnum

    note bottom of Document
      Invariants:
      * Each Document belongs to exactly one Transaction via TransactionRef.
      * Status transitions: DRAFT->REQUESTED->SUBMITTED->APPROVED|NEEDS_REVISION|REJECTED
      * REQUEST flow: client uploads; UPLOAD flow: broker uploads and shares.
      * requiresSignature=true requires source document before sending request.
      * Only visibleToClient=true documents shown to Client role.
      * Soft delete via deletedAt (never hard-deleted).
    end note

    note bottom of TransactionStageChecklistState
      Auto-checked when matching document
      reaches APPROVED (REQUEST flow) or
      SUBMITTED (UPLOAD flow).
      Broker can manually override.
    end note
  }


  '======================
  ' APPOINTMENT MANAGEMENT CONTEXT
  '======================
  package "Appointment Management" as AppointmentBC <<Rectangle>> #LightSalmon {

    AGGREGATE_ROOT(Appointment) #lightsalmon {
      appointmentId: UUID
      title: String
      transactionId: UUID?
      propertyId: UUID?
      brokerId: UUID
      clientId: UUID
      fromDateTime: DateTime
      toDateTime: DateTime
      status: AppointmentStatusEnum
      initiatedBy: InitiatorType
      location: String
      notes: String
      refusalReason: String
      cancellationReason: String
      numberOfVisitors: Integer
      reminderSent: Boolean
    }

    ENUM(AppointmentStatusEnum) {
      PROPOSED
      CONFIRMED
      DECLINED
      CANCELLED
    }

    ENUM(InitiatorType) {
      BROKER
      CLIENT
    }

    Appointment --> AppointmentStatusEnum
    Appointment --> InitiatorType

    note bottom of Appointment
      Invariants:
      * Can be standalone (no transactionId) or linked to a transaction.
      * Only PROPOSED appointments can be confirmed/declined.
      * Only PROPOSED or CONFIRMED can be cancelled.
    end note
  }


  '======================
  ' NOTIFICATIONS CONTEXT
  '======================
  package "Notifications" as NotificationsBC <<Rectangle>> #Thistle {

    AGGREGATE_ROOT(Notification) #Thistle {
      id: Long
      publicId: UUID
      recipientId: String
      title: String
      message: String
      type: NotificationType
      category: NotificationCategory
      isRead: Boolean
      relatedTransactionId: String
      createdAt: DateTime
    }

    ENUM(NotificationType) {
      GENERAL
      BROADCAST
    }

    ENUM(NotificationCategory) {
      GENERAL
      TRANSACTION
      DOCUMENT
      APPOINTMENT
    }

    Notification --> NotificationType
    Notification --> NotificationCategory

    note bottom of Notification
      Invariants:
      * publicId is the client-facing UUID.
      * recipientId maps to UserAccount.id.
    end note
  }


  '======================
  ' ANALYTICS CONTEXT
  '======================
  package "Analytics" as AnalyticsBC <<Rectangle>> #LightGray {

    AGGREGATE_ROOT(BrokerMetricsSnapshot) #lightgray {
      brokerUserId: UUID
      activeTransactionsCount: Integer
      activeClientsCount: Integer
      totalCommission: Decimal
      pendingDocumentReviewsCount: Integer
      expiringOffersCount: Integer
      approachingConditionsCount: Integer
    }

    note bottom of BrokerMetricsSnapshot
      Computed live from operational data
      by DashboardService (not persisted snapshot).
    end note
  }


  '======================
  ' CROSS-CONTEXT RELATIONSHIPS
  '======================

  ' TRANSACTION <-> USER MANAGEMENT
  TransactionBC.Transaction --> UserBC.UserAccount : "Client (Buyer/Seller)"
  TransactionBC.Transaction --> UserBC.UserAccount : "Broker"
  TransactionBC.PinnedTransaction --> UserBC.UserAccount : "Broker"

  ' DOCUMENT MANAGEMENT <-> TRANSACTION MANAGEMENT
  DocumentBC.Document --> TransactionBC.Transaction : "belongs to"
  DocumentBC.DocumentConditionLink --> TransactionBC.Condition : "links to"

  ' APPOINTMENT MANAGEMENT <-> TRANSACTION MANAGEMENT
  AppointmentBC.Appointment --> TransactionBC.Transaction : "optional link"
  AppointmentBC.Appointment --> UserBC.UserAccount : "Participants"

  ' NOTIFICATIONS <-> OTHER CONTEXTS
  NotificationsBC.Notification ..> DocumentBC.Document : "Refers to"
  NotificationsBC.Notification ..> TransactionBC.Transaction : "Refers to"
  NotificationsBC.Notification ..> AppointmentBC.Appointment : "Refers to"
  NotificationsBC.Notification --> UserBC.UserAccount : "Recipient"

  ' ANALYTICS <-> OPERATIONAL DATA
  AnalyticsBC.BrokerMetricsSnapshot ..> TransactionBC.Transaction : "aggregates"
  AnalyticsBC.BrokerMetricsSnapshot ..> DocumentBC.Document : "counts pending"
  AnalyticsBC.BrokerMetricsSnapshot --> UserBC.UserAccount : "Broker"

}

@enduml
