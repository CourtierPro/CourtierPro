@startuml DesignLevelSequenceDiagram_ClientSubmit
!theme plain
skinparam backgroundColor #FEFEFE
skinparam ParticipantBackgroundColor #E3F2FD
skinparam ParticipantBorderColor #1976D2
skinparam SequenceLifeLineBorderColor #757575
skinparam ArrowColor #424242

title DLSD Flow 2: Client Submits Document

actor "Client" as ClientActor

box "Frontend (React 19 SPA)" #E0F7FA
  participant "DocumentsCenter" as FE
  participant "axiosInstance" as Axios
end box

box "Presentation Layer" #E8F5E9
  participant "DocumentController" as DocCtrl
end box

box "Business Layer" #FFF3E0
  participant "DocumentServiceImpl" as DocSvc
  participant "EmailService" as EmailSvc
  participant "NotificationService" as NotifSvc
end box

box "Data / Infrastructure" #F3E5F5
  participant "DocumentRepository" as DocRepo
  participant "UserAccountRepository" as UserRepo
  participant "ObjectStorageService" as Storage
end box

== Client Uploads Document (REQUESTED -> SUBMITTED) ==

ClientActor -> FE: Selects file and clicks Upload
FE -> Axios: POST /transactions/{txId}/documents/{docId}/submit (multipart)
Axios -> DocCtrl: submitDocument(txId, docId, file, userId, CLIENT)
activate DocCtrl

DocCtrl -> DocSvc: submitDocument(txId, docId, file, userId, CLIENT)
activate DocSvc

DocSvc -> DocRepo: findByDocumentId(docId)
DocRepo --> DocSvc: Document

note right of DocSvc
  validateFile(file) - type, size
  validateCanSubmit(doc) - status in [REQUESTED, NEEDS_REVISION]
end note

DocSvc -> Storage: uploadFile(txId, docId, file)
Storage --> DocSvc: StorageObject{s3Key, fileName, mimeType, sizeBytes}

note right of DocSvc
  Create DocumentVersion (uploaderType=CLIENT)
  Set status = SUBMITTED
end note

DocSvc -> DocRepo: save(document)

DocSvc -> UserRepo: findById(brokerId)
UserRepo --> DocSvc: UserAccount (broker)

DocSvc -> EmailSvc: sendDocumentSubmittedNotification(brokerEmail, ...)
DocSvc -> NotifSvc: createDocumentNotification(for broker)

DocSvc --> DocCtrl: DocumentResponseDTO
deactivate DocSvc
DocCtrl --> Axios: HTTP 200
deactivate DocCtrl
Axios --> FE: Document (SUBMITTED)
FE --> ClientActor: Show success

@enduml
