@startuml DesignLevelSequenceDiagram_BrokerReview
!theme plain
skinparam backgroundColor #FEFEFE
skinparam ParticipantBackgroundColor #E3F2FD
skinparam ParticipantBorderColor #1976D2
skinparam SequenceLifeLineBorderColor #757575
skinparam ArrowColor #424242

title DLSD Flow 3: Broker Reviews Document

actor "Broker" as BrokerActor

box "Frontend (React 19 SPA)" #E0F7FA
  participant "DocumentsCenter" as FE
  participant "axiosInstance" as Axios
end box

box "Presentation Layer" #E8F5E9
  participant "DocumentController" as DocCtrl
end box

box "Business Layer" #FFF3E0
  participant "DocumentServiceImpl" as DocSvc
  participant "EmailService" as EmailSvc
  participant "NotificationService" as NotifSvc
end box

box "Data / Infrastructure" #F3E5F5
  participant "DocumentRepository" as DocRepo
  participant "ChecklistStateRepo" as CheckRepo
  participant "ObjectStorageService" as Storage
end box

== Step 1: Download Submitted File ==

BrokerActor -> FE: Clicks Review on submitted document

FE -> Axios: GET .../versions/{verId}/download
Axios -> DocCtrl: getDocumentDownloadUrl(txId, docId, verId)
activate DocCtrl
DocCtrl -> DocSvc: getDocumentDownloadUrl(docId, verId, userId)
DocSvc -> Storage: getPreSignedUrl(s3Key, 15)
Storage --> DocSvc: preSignedUrl
DocSvc --> DocCtrl: url
DocCtrl --> Axios: HTTP 200 {url}
deactivate DocCtrl
Axios --> FE: preSignedUrl
FE --> BrokerActor: Opens document in browser

== Step 2: Submit Review Decision ==

BrokerActor -> FE: Selects decision in DocumentReviewModal
FE -> Axios: PATCH /transactions/{txId}/documents/{docId}/review
Axios -> DocCtrl: reviewDocument(txId, docId, {decision, comments}, brokerId)
activate DocCtrl

DocCtrl -> DocSvc: reviewDocument(txId, docId, dto, brokerId)
activate DocSvc

DocSvc -> DocRepo: findByDocumentId(docId)
DocRepo --> DocSvc: Document

note right of DocSvc
  validateCanReview(doc) - status == SUBMITTED
  Set status = decision, brokerNotes = comments
end note

DocSvc -> DocRepo: save(document)

opt decision == APPROVED
  DocSvc -> CheckRepo: upsert auto-check for stage checklist item
end

DocSvc -> EmailSvc: sendDocumentStatusUpdatedNotification(...)
DocSvc -> NotifSvc: createDocumentNotification(for client)

DocSvc --> DocCtrl: DocumentResponseDTO
deactivate DocSvc
DocCtrl --> Axios: HTTP 200
deactivate DocCtrl
Axios --> FE: Document (APPROVED / NEEDS_REVISION / REJECTED)
FE --> BrokerActor: Show updated status

@enduml
