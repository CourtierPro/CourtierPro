@startuml DesignLevelSequenceDiagram
!theme plain
skinparam backgroundColor #FEFEFE
skinparam ParticipantBackgroundColor #E3F2FD
skinparam ParticipantBorderColor #1976D2
skinparam SequenceLifeLineBorderColor #757575
skinparam ArrowColor #424242

title Design Level Sequence Diagram: Manage Transaction Documents

actor "Broker" as BrokerActor
actor "Client" as ClientActor

box "Frontend (React 19 SPA)" #E0F7FA
  participant "DocumentsCenter" as FE
  participant "axiosInstance" as Axios
end box

box "Presentation Layer" #E8F5E9
  participant "DocumentController" as DocCtrl
end box

box "Business Layer" #FFF3E0
  participant "DocumentServiceImpl" as DocSvc
  participant "EmailService" as EmailSvc
  participant "NotificationService" as NotifSvc
end box

box "Data / Infrastructure" #F3E5F5
  participant "DocumentRepository" as DocRepo
  participant "TransactionRepository" as TxRepo
  participant "UserAccountRepository" as UserRepo
  participant "ChecklistStateRepo" as CheckRepo
  participant "ObjectStorageService" as Storage
end box

== Flow 1: Broker Requests Document from Client ==

BrokerActor -> FE: Opens RequestDocumentModal, fills form
FE -> Axios: POST /transactions/{txId}/documents
Axios -> DocCtrl: createDocument(txId, dto, userId)
activate DocCtrl

DocCtrl -> DocSvc: createDocument(txId, dto, userId)
activate DocSvc

DocSvc -> TxRepo: findByTransactionId(txId)
TxRepo --> DocSvc: Transaction

note right of DocSvc
  Validate broker has EDIT_DOCUMENTS permission
  Create Document with status=REQUESTED, flow=REQUEST
  If requiresSignature, validate source file attached
end note

DocSvc -> DocRepo: save(Document{status=REQUESTED, flow=REQUEST})
DocRepo --> DocSvc: Document

DocSvc -> UserRepo: findById(clientId)
UserRepo --> DocSvc: UserAccount (client)

DocSvc -> EmailSvc: sendDocumentRequestedNotification(clientEmail, ...)
DocSvc -> NotifSvc: createDocumentNotification(category=DOCUMENT)

DocSvc --> DocCtrl: DocumentResponseDTO
deactivate DocSvc
DocCtrl --> Axios: HTTP 201
deactivate DocCtrl
Axios --> FE: Document (REQUESTED)
FE --> BrokerActor: Show document with REQUESTED status

== Flow 2: Client Submits Document ==

ClientActor -> FE: Selects file and clicks Upload
FE -> Axios: POST /transactions/{txId}/documents/{docId}/submit (multipart)
Axios -> DocCtrl: submitDocument(txId, docId, file, userId, CLIENT)
activate DocCtrl

DocCtrl -> DocSvc: submitDocument(txId, docId, file, userId, CLIENT)
activate DocSvc

DocSvc -> DocRepo: findByDocumentId(docId)
DocRepo --> DocSvc: Document

note right of DocSvc
  validateFile(file) - type, size
  validateCanSubmit(doc) - status in [REQUESTED, NEEDS_REVISION]
end note

DocSvc -> Storage: uploadFile(txId, docId, file)
Storage --> DocSvc: StorageObject{s3Key, fileName, mimeType, sizeBytes}

note right of DocSvc
  Create DocumentVersion (uploaderType=CLIENT)
  Set status = SUBMITTED
end note

DocSvc -> DocRepo: save(document)

DocSvc -> UserRepo: findById(brokerId)
UserRepo --> DocSvc: UserAccount (broker)

DocSvc -> EmailSvc: sendDocumentSubmittedNotification(brokerEmail, ...)
DocSvc -> NotifSvc: createDocumentNotification(for broker)

DocSvc --> DocCtrl: DocumentResponseDTO
deactivate DocSvc
DocCtrl --> Axios: HTTP 200
deactivate DocCtrl
Axios --> FE: Document (SUBMITTED)
FE --> ClientActor: Show success

== Flow 3: Broker Reviews Document ==

BrokerActor -> FE: Clicks Review on submitted document

FE -> Axios: GET .../versions/{verId}/download
Axios -> DocCtrl: getDocumentDownloadUrl(txId, docId, verId)
activate DocCtrl
DocCtrl -> DocSvc: getDocumentDownloadUrl(docId, verId, userId)
DocSvc -> Storage: getPreSignedUrl(s3Key, 15)
Storage --> DocSvc: preSignedUrl
DocSvc --> DocCtrl: url
DocCtrl --> Axios: HTTP 200 {url}
deactivate DocCtrl
Axios --> FE: preSignedUrl
FE --> BrokerActor: Opens document in browser

BrokerActor -> FE: Selects decision in DocumentReviewModal
FE -> Axios: PATCH /transactions/{txId}/documents/{docId}/review
Axios -> DocCtrl: reviewDocument(txId, docId, {decision, comments}, brokerId)
activate DocCtrl

DocCtrl -> DocSvc: reviewDocument(txId, docId, dto, brokerId)
activate DocSvc

DocSvc -> DocRepo: findByDocumentId(docId)
DocRepo --> DocSvc: Document

note right of DocSvc
  validateCanReview(doc) - status == SUBMITTED
  Set status = decision, brokerNotes = comments
end note

DocSvc -> DocRepo: save(document)

opt decision == APPROVED
  DocSvc -> CheckRepo: upsert auto-check for stage checklist item
end

DocSvc -> EmailSvc: sendDocumentStatusUpdatedNotification(...)
DocSvc -> NotifSvc: createDocumentNotification(for client)

DocSvc --> DocCtrl: DocumentResponseDTO
deactivate DocSvc
DocCtrl --> Axios: HTTP 200
deactivate DocCtrl
Axios --> FE: Document (APPROVED / NEEDS_REVISION / REJECTED)
FE --> BrokerActor: Show updated status

@enduml
