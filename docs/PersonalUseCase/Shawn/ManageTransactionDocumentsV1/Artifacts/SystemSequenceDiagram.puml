@startuml SystemSequenceDiagram
!pragma teoz true

title System Sequence Diagram: Manage Transaction Documents

actor "Broker" as Broker
actor "Client" as Client
participant "CourtierPro\nSystem" as System

== Scenario 1: Broker Requests Document from Client (REQUEST Flow) ==

Broker -> System: getDocumentsForTransaction(transactionId, userId)
System --> Broker: documentsList (with statuses and versions)

Broker -> System: requestDocument(transactionId, {docType, expectedFrom,\nstage, notes, dueDate, flow=REQUEST, requiresSignature})
System --> Broker: createdDocument (status=REQUESTED)

note right of System
  System internally:
  - Validates transaction exists and broker has EDIT_DOCUMENTS permission
  - Creates Document entity with status=REQUESTED, flow=REQUEST
  - If requiresSignature, broker attaches source file before sending
  - Sends bilingual email to Client (via EmailService)
  - Creates in-app Notification (category=DOCUMENT)
  - Records timeline entry
end note

== Scenario 2: Broker Uploads Document for Client (UPLOAD Flow) ==

Broker -> System: createDocument(transactionId, {docType, stage,\nnotes, status=DRAFT, flow=UPLOAD})
System --> Broker: createdDocument (status=DRAFT, flow=UPLOAD)

Broker -> System: uploadFileToDocument(transactionId, documentId, file)
System --> Broker: updatedDocument (version added)

Broker -> System: shareDocumentWithClient(transactionId, documentId)
System --> Broker: updatedDocument (status=SUBMITTED, visibleToClient=true)

note right of System
  System internally:
  - Updates status DRAFT -> SUBMITTED
  - Sets visibleToClient=true
  - Sends email notification to Client
  - Creates in-app notification
  - Auto-checks stage checklist item
end note

== Scenario 3: Client Submits Document ==

Client -> System: getDocumentsForTransaction(transactionId, userId)
System --> Client: pendingDocuments (filtered: DRAFT hidden, visibleToClient only)

Client -> System: submitDocument(transactionId, documentId, file)
System --> Client: updatedDocument (status=SUBMITTED)

note right of System
  System internally:
  - Validates file (type, size constraints)
  - Uploads file to Cloudflare R2 via ObjectStorageService
  - Creates DocumentVersion (uploaderType=CLIENT)
  - Updates status REQUESTED -> SUBMITTED
  - Sends email notification to Broker
  - Creates in-app notification
  - Records timeline entry
end note

== Scenario 4: Broker Reviews Document ==

Broker -> System: getDocumentsForTransaction(transactionId, userId)
System --> Broker: documentsWithSubmissions

Broker -> System: getDocumentDownloadUrl(transactionId, documentId, versionId)
System --> Broker: preSignedUrl (from Cloudflare R2, time-limited)

Broker -> System: reviewDocument(transactionId, documentId,\n{decision, comments})
System --> Broker: updatedDocument

note right of System
  decision can be:
  - APPROVED -> terminal state, checklist auto-checked
  - NEEDS_REVISION -> client must resubmit
  - REJECTED -> terminal state

  System sends bilingual email to Client
  with decision and broker comments.
  Creates in-app notification.
end note

== Scenario 5: Client Downloads Document ==

Client -> System: getDocumentDownloadUrl(transactionId, documentId, versionId)
alt Authorized (participant in transaction)
  System --> Client: preSignedUrl
else Not Authorized
  System --> Client: 403 Forbidden
end

@enduml
