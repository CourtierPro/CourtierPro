@startuml DesignLevelClassDiagram
skinparam classAttributeIconSize 0
skinparam linetype ortho

title Design Level Class Diagram: Document Management

package "Presentation Layer" #LightBlue {
  class DocumentController {
    - service: DocumentService
    --
    + getDocuments(transactionId, userId): List<DocumentResponseDTO>
    + createDocument(transactionId, dto, userId): DocumentResponseDTO
    + getDocument(transactionId, documentId, userId): DocumentResponseDTO
    + updateDocument(transactionId, documentId, dto, userId): DocumentResponseDTO
    + deleteDocument(transactionId, documentId, userId): void
    + submitDocument(transactionId, documentId, file, userId, type): DocumentResponseDTO
    + uploadFileToDocument(transactionId, documentId, file, userId): DocumentResponseDTO
    + getDocumentDownloadUrl(transactionId, documentId, versionId): Map
    + reviewDocument(transactionId, documentId, reviewDto, brokerId): DocumentResponseDTO
    + sendDocumentRequest(transactionId, documentId, brokerId): DocumentResponseDTO
    + shareDocumentWithClient(transactionId, documentId, brokerId): DocumentResponseDTO
    + getStageChecklist(transactionId, stage, userId): StageChecklistResponseDTO
    + setChecklistManualState(transactionId, itemKey, dto, brokerId): StageChecklistResponseDTO
  }

  class GlobalDocumentController {
    - service: DocumentService
    --
    + getAllDocumentsForUser(userId): List<DocumentResponseDTO>
    + getOutstandingDocuments(brokerId): List<OutstandingDocumentDTO>
    + sendDocumentReminder(documentId, brokerId): void
  }

  class DocumentRequestDTO {
    + docType: DocumentTypeEnum
    + customTitle: String
    + expectedFrom: DocumentPartyEnum
    + stage: StageEnum
    + brokerNotes: String
    + visibleToClient: Boolean
    + conditionIds: List<UUID>
    + dueDate: LocalDateTime
    + status: DocumentStatusEnum
    + flow: DocumentFlowEnum
    + requiresSignature: Boolean
  }

  class DocumentResponseDTO {
    + documentId: UUID
    + transactionRef: TransactionRef
    + docType: DocumentTypeEnum
    + customTitle: String
    + status: DocumentStatusEnum
    + expectedFrom: DocumentPartyEnum
    + stage: StageEnum
    + flow: DocumentFlowEnum
    + requiresSignature: Boolean
    + brokerNotes: String
    + visibleToClient: Boolean
    + versions: List<DocumentVersionResponseDTO>
    + lastUpdatedAt: LocalDateTime
    + dueDate: LocalDateTime
  }

  class DocumentReviewRequestDTO {
    + decision: DocumentStatusEnum
    + comments: String
  }

  class DocumentVersionResponseDTO {
    + versionId: UUID
    + uploadedAt: LocalDateTime
    + uploadedBy: UploadedBy
    + storageObject: StorageObject
  }

  class OutstandingDocumentDTO {
    + id: UUID
    + title: String
    + transactionAddress: String
    + clientName: String
    + clientEmail: String
    + dueDate: LocalDateTime
    + daysOutstanding: Integer
    + status: String
  }

  class StageChecklistResponseDTO {
    + stage: String
    + items: List<StageChecklistItemDTO>
  }

  class StageChecklistItemDTO {
    + itemKey: String
    + label: String
    + docType: DocumentTypeEnum
    + flow: DocumentFlowEnum
    + requiresSignature: Boolean
    + checked: Boolean
    + source: String
    + documentId: UUID
    + documentStatus: DocumentStatusEnum
  }

  class ChecklistToggleRequestDTO {
    + stage: String
    + checked: Boolean
  }
}

package "Business Layer" #LightGreen {
  interface DocumentService {
    + getDocumentsForTransaction(txId, userId): List<DocumentResponseDTO>
    + getDocument(docId, userId): DocumentResponseDTO
    + createDocument(txId, dto, userId): DocumentResponseDTO
    + updateDocument(docId, dto, userId): DocumentResponseDTO
    + deleteDocument(docId, userId): void
    + submitDocument(txId, docId, file, userId, type): DocumentResponseDTO
    + uploadFileToDocument(txId, docId, file, userId, type): DocumentResponseDTO
    + getAllDocumentsForUser(userId): List<DocumentResponseDTO>
    + getDocumentDownloadUrl(docId, verId, userId): String
    + reviewDocument(txId, docId, dto, brokerId): DocumentResponseDTO
    + sendDocumentRequest(docId, brokerId): DocumentResponseDTO
    + shareDocumentWithClient(docId, brokerId): DocumentResponseDTO
    + getOutstandingDocumentSummary(brokerId): List<OutstandingDocumentDTO>
    + sendDocumentReminder(docId, brokerId): void
    + getStageChecklist(txId, stage, userId): StageChecklistResponseDTO
    + setChecklistManualState(txId, stage, itemKey, checked, brokerId): StageChecklistResponseDTO
  }

  class DocumentServiceImpl {
    - documentRepository: DocumentRepository
    - transactionRepository: TransactionRepository
    - userAccountRepository: UserAccountRepository
    - notificationService: NotificationService
    - emailService: EmailService
    - objectStorageService: ObjectStorageService
    - stageTemplateRegistry: StageDocumentTemplateRegistry
    - checklistStateRepository: ChecklistStateRepository
    --
    + getDocumentsForTransaction(txId, userId): List<DocumentResponseDTO>
    + createDocument(txId, dto, userId): DocumentResponseDTO
    + submitDocument(txId, docId, file, userId, type): DocumentResponseDTO
    + uploadFileToDocument(txId, docId, file, userId, type): DocumentResponseDTO
    + reviewDocument(txId, docId, dto, brokerId): DocumentResponseDTO
    + sendDocumentRequest(docId, brokerId): DocumentResponseDTO
    + shareDocumentWithClient(docId, brokerId): DocumentResponseDTO
    + getStageChecklist(txId, stage, userId): StageChecklistResponseDTO
    + setChecklistManualState(txId, stage, itemKey, checked, brokerId): StageChecklistResponseDTO
    - validateFile(file): void
    - validateCanSubmit(document): void
    - validateCanReview(document): void
    - mapToResponseDTO(entity): DocumentResponseDTO
    - filterForClientVisibility(docs, userId): List<Document>
  }

  class StageDocumentTemplateRegistry {
    - stageTemplates: Map<StageEnum, List<StageDocumentTemplate>>
    --
    + getTemplatesForStage(stage): List<StageDocumentTemplate>
    + getAllTemplates(): Map<StageEnum, List<StageDocumentTemplate>>
  }

  interface NotificationService {
    + createDocumentNotification(doc, recipientId, category): void
  }

  class EmailService {
    + sendDocumentRequestedNotification(email, clientName, brokerName, docName, docType, notes, lang, requiresSignature): void
    + sendDocumentSubmittedNotification(doc, brokerEmail, uploaderName, docName, docType, lang): void
    + sendDocumentStatusUpdatedNotification(doc, clientEmail, clientName, brokerName, docName, docType, lang): void
    + sendDocumentEditedNotification(clientEmail, clientName, brokerName, docName, docType, lang): void
  }
}

package "Data Layer" #LightYellow {
  interface DocumentRepository {
    + findByDocumentId(docId): Optional<Document>
    + findByTransactionRef_TransactionId(txId): List<Document>
    + findByTransactionRef_TransactionIdAndStage(txId, stage): List<Document>
    + findByTransactionRef_TransactionIdAndTemplateKey(txId, key): Optional<Document>
    + findByUserId(userId): List<Document>
    + searchDocuments(txId, query): List<Document>
    + findOutstandingDocumentsForBroker(brokerId, now): List<Document>
    + findByTransactionRefClientIdIn(clientIds): List<Document>
  }

  interface TransactionRepository {
    + findByTransactionId(txId): Optional<Transaction>
  }

  interface UserAccountRepository {
    + findById(userId): Optional<UserAccount>
    + findByAuth0UserId(auth0Id): Optional<UserAccount>
  }

  interface ChecklistStateRepository {
    + findByTransactionIdAndStage(txId, stage): List<TransactionStageChecklistState>
    + findByTransactionIdAndStageAndItemKey(txId, stage, key): Optional<TransactionStageChecklistState>
  }

  class Document <<Entity>> {
    - id: Long
    - documentId: UUID
    - transactionRef: TransactionRef
    - docType: DocumentTypeEnum
    - customTitle: String
    - status: DocumentStatusEnum
    - expectedFrom: DocumentPartyEnum
    - flow: DocumentFlowEnum
    - requiresSignature: boolean
    - stage: StageEnum
    - templateKey: String
    - autoGenerated: boolean
    - versions: List<DocumentVersion>
    - brokerNotes: String
    - visibleToClient: boolean
    - dueDate: LocalDateTime
    - createdAt: LocalDateTime
    - lastUpdatedAt: LocalDateTime
    - deletedAt: LocalDateTime
    - deletedBy: UUID
  }

  class DocumentVersion <<Entity>> {
    - id: Long
    - versionId: UUID
    - uploadedAt: LocalDateTime
    - uploadedBy: UploadedBy
    - storageObject: StorageObject
    - document: Document
    - deletedAt: LocalDateTime
    - deletedBy: UUID
  }

  class TransactionStageChecklistState <<Entity>> {
    - id: Long
    - transactionId: UUID
    - stage: StageEnum
    - itemKey: String
    - manualChecked: Boolean
    - manualCheckedBy: UUID
    - manualCheckedAt: LocalDateTime
    - autoChecked: boolean
    - autoCheckedAt: LocalDateTime
  }

  class TransactionRef <<Value Object>> {
    - transactionId: UUID
    - clientId: UUID
    - side: TransactionSide
  }

  class StorageObject <<Value Object>> {
    - s3Key: String
    - fileName: String
    - mimeType: String
    - sizeBytes: Long
  }

  class UploadedBy <<Value Object>> {
    - uploaderType: UploadedByRefEnum
    - party: DocumentPartyEnum
    - uploaderId: UUID
    - externalName: String
  }
}

package "Infrastructure Layer" #LightCoral {
  interface ObjectStorageService {
    + uploadFile(txId, docId, file): StorageObject
    + getPreSignedUrl(s3Key, expirationMinutes): String
    + deleteFile(s3Key): void
  }

  class ObjectStorageServiceImpl {
    - s3Client: S3Client
    - bucketName: String
    --
    + uploadFile(txId, docId, file): StorageObject
    + getPreSignedUrl(s3Key, expirationMinutes): String
    + deleteFile(s3Key): void
    - generateS3Key(txId, docId, fileName): String
  }
}

package "Enums" #LightGray {
  enum DocumentTypeEnum {
    MORTGAGE_PRE_APPROVAL
    MORTGAGE_APPROVAL
    PROOF_OF_FUNDS
    PROOF_OF_INCOME
    ID_VERIFICATION
    GOVERNMENT_ID_1
    GOVERNMENT_ID_2
    EMPLOYMENT_LETTER
    PAY_STUBS
    CREDIT_REPORT
    BROKERAGE_CONTRACT
    CERTIFICATE_OF_LOCATION
    PROMISE_TO_PURCHASE
    ACCEPTED_PROMISE_TO_PURCHASE
    SELLERS_DECLARATION
    ACKNOWLEDGED_SELLERS_DECLARATION
    INSPECTION_REPORT
    INSURANCE_LETTER
    NOTARY_CONTACT_SHEET
    COMPARATIVE_MARKET_ANALYSIS
    MUNICIPAL_TAX_BILLS
    MORTGAGE_BALANCE_STATEMENT
    SCHOOL_TAX_BILLS
    CURRENT_DEED_OF_SALE
    BANK_STATEMENT
    OTHER
  }

  enum DocumentStatusEnum {
    DRAFT
    REQUESTED
    SUBMITTED
    APPROVED
    NEEDS_REVISION
    REJECTED
  }

  enum DocumentPartyEnum {
    BUYER
    SELLER
    BROKER
    LENDER
    NOTARY
    INSPECTOR
    CLIENT
    OTHER
  }

  enum DocumentFlowEnum {
    REQUEST
    UPLOAD
  }

  enum UploadedByRefEnum {
    CLIENT
    BROKER
    SYSTEM
    EXTERNAL
  }

  enum StageEnum {
    FINANCIAL_PREPARATION
    PROPERTY_SEARCH
    OFFER_AND_NEGOTIATION
    FINANCING_AND_CONDITIONS
    NOTARY_AND_SIGNING
    POSSESSION
    INITIAL_CONSULTATION
    PUBLISH_LISTING
    HANDOVER
  }
}

' === RELATIONSHIPS ===

' Presentation -> Business
DocumentController --> DocumentService : uses
GlobalDocumentController --> DocumentService : uses
DocumentController ..> DocumentRequestDTO : receives
DocumentController ..> DocumentResponseDTO : returns
DocumentController ..> DocumentReviewRequestDTO : receives
DocumentController ..> StageChecklistResponseDTO : returns
GlobalDocumentController ..> OutstandingDocumentDTO : returns

' Business layer
DocumentServiceImpl ..|> DocumentService : implements
DocumentServiceImpl --> DocumentRepository : uses
DocumentServiceImpl --> TransactionRepository : uses
DocumentServiceImpl --> UserAccountRepository : uses
DocumentServiceImpl --> ChecklistStateRepository : uses
DocumentServiceImpl --> NotificationService : uses
DocumentServiceImpl --> EmailService : uses
DocumentServiceImpl --> ObjectStorageService : uses
DocumentServiceImpl --> StageDocumentTemplateRegistry : uses
DocumentServiceImpl ..> Document : manages
DocumentServiceImpl ..> DocumentResponseDTO : creates

' Data layer
DocumentRepository ..> Document : persists
ChecklistStateRepository ..> TransactionStageChecklistState : persists

Document "1" *-- "1" TransactionRef : contains
Document "1" *-- "0..*" DocumentVersion : contains
Document --> DocumentTypeEnum
Document --> DocumentStatusEnum
Document --> DocumentPartyEnum
Document --> DocumentFlowEnum
Document --> StageEnum

DocumentVersion "1" *-- "1" StorageObject : contains
DocumentVersion "1" *-- "1" UploadedBy : contains
UploadedBy --> UploadedByRefEnum
UploadedBy --> DocumentPartyEnum

TransactionStageChecklistState --> StageEnum

' Infrastructure
ObjectStorageServiceImpl ..|> ObjectStorageService : implements

' DTO compositions
DocumentResponseDTO ..> DocumentVersionResponseDTO : contains
StageChecklistResponseDTO ..> StageChecklistItemDTO : contains

@enduml
