@startuml StateTransitionDiagram
skinparam state {
  BackgroundColor White
  BorderColor Black
  ArrowColor Black
}

title State Transition Diagram: Document Status Lifecycle

[*] --> DRAFT : Broker creates\ndocument (default)

state DRAFT #LightGray {
  DRAFT : Document created but not yet sent/shared
  DRAFT : Broker can attach files, edit details
  DRAFT : Not visible to client
}

state REQUESTED #LightYellow {
  REQUESTED : Document request sent to client
  REQUESTED : Awaiting submission from expected party
  REQUESTED : Email + in-app notification sent
}

state SUBMITTED #LightBlue {
  SUBMITTED : Document/file has been uploaded
  SUBMITTED : Awaiting broker review (REQUEST flow)
  SUBMITTED : Or shared with client (UPLOAD flow)
}

state APPROVED #LightGreen {
  APPROVED : Document accepted by broker
  APPROVED : Stage checklist auto-checked
  APPROVED : (Terminal State)
}

state NEEDS_REVISION #Orange {
  NEEDS_REVISION : Broker requested changes
  NEEDS_REVISION : Client must resubmit with corrections
  NEEDS_REVISION : Feedback notes provided
}

state REJECTED #LightCoral {
  REJECTED : Document permanently rejected by broker
  REJECTED : With rejection reason
  REJECTED : (Terminal State)
}

' === REQUEST FLOW TRANSITIONS ===
DRAFT --> REQUESTED : Broker sends request\n[sendDocumentRequest]\n(requiresSignature? source doc must exist)
DRAFT -[#blue]-> DRAFT : Broker uploads\nreference file\n[uploadFileToDocument]

REQUESTED --> SUBMITTED : Client/Broker uploads file\n[submitDocument]\n[file valid, stored in R2]
REQUESTED --> REQUESTED : Upload fails\n[file invalid / too large]

SUBMITTED --> APPROVED : Broker approves\n[reviewDocument: APPROVED]
SUBMITTED --> NEEDS_REVISION : Broker requests revision\n[reviewDocument: NEEDS_REVISION]\n(with feedback notes)
SUBMITTED --> REJECTED : Broker rejects\n[reviewDocument: REJECTED]\n(with reason)

NEEDS_REVISION --> SUBMITTED : Client uploads revised file\n[submitDocument]

' === UPLOAD FLOW TRANSITIONS ===
DRAFT -[#green,dashed]-> SUBMITTED : Broker shares with client\n[shareDocumentWithClient]\n(UPLOAD flow only;\nvisibleToClient=true)

' Terminal states
APPROVED --> [*]
REJECTED --> [*]

note right of DRAFT
  **REQUEST flow:** DRAFT -> REQUESTED -> SUBMITTED -> review
  **UPLOAD flow:** DRAFT -> SUBMITTED (shared)
  Broker can also create directly as REQUESTED
  (skipping DRAFT) via createDocument with status=REQUESTED
end note

note bottom of NEEDS_REVISION
  Client resubmits, returning
  to SUBMITTED for re-review.
  This cycle can repeat.
end note

@enduml
